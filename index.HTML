<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Vi√°ticos (Seguro con Usuario)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hide { display: none !important; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .ai-sparkle {
            background: linear-gradient(45deg, #4f46e5, #9333ea, #ec4899);
            background-size: 200% 200%;
            animation: gradient-flow 3s ease infinite;
            color: white;
            border: none;
        }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #debug-bar {
            background-color: #dcfce7;
            border-bottom: 1px solid #86efac;
            color: #166534;
            font-size: 0.75rem;
            padding: 4px 8px;
            text-align: center;
            font-family: monospace;
        }

        @media print {
            @page { margin: 0; size: auto; }
            body { background: white; height: auto; overflow: visible; }
            body * { visibility: hidden; }
            #view-report, #view-report * { visibility: visible; }
            #view-report { 
                position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px;
                background: white !important; z-index: 9999;
            }
            .no-print { display: none !important; }
            #debug-bar, nav, #protocol-warning, #full-screen-loader { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- Barra de Estado -->
    <div id="debug-bar" class="flex justify-between items-center no-print">
        <span>üîí BASE DE DATOS PRIVADA</span>
        <span id="connection-status">Esperando Login...</span>
    </div>

    <!-- PANTALLA DE LOGIN (USUARIO) -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-6">
                <i class="fa-solid fa-user-shield text-green-600 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Acceso Seguro</h2>
            <p class="text-gray-500 mb-6 text-sm">Ingresa un nombre de usuario para que tus datos nunca se pierdan.</p>
            
            <form onsubmit="app.handleLogin(event)" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Nombre de Usuario</label>
                    <input type="text" id="login-username" required placeholder="Ej. JuanPerez" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none uppercase" style="text-transform: uppercase;">
                    <p class="text-[10px] text-gray-400 mt-1">Sin espacios.</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Contrase√±a</label>
                    <input type="password" id="login-pass" required placeholder="******" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                    <p class="text-[10px] text-gray-400 mt-1">M√≠nimo 6 caracteres.</p>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition shadow-lg">
                    Entrar / Registrarse
                </button>
            </form>
            <p class="text-xs text-gray-400 mt-4">Si el usuario no existe, se crear√° autom√°ticamente.</p>
        </div>
    </div>

    <!-- Overlay de Carga -->
    <div id="full-screen-loader" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex flex-col items-center justify-center text-white no-print">
        <div class="loader mb-4"></div>
        <p id="loader-text" class="text-lg font-bold">Procesando...</p>
    </div>

    <!-- MODALES DE UI -->
    <div id="custom-modal-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[150] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-fade-in-up">
            <h3 class="text-lg font-bold text-gray-900 mb-2" id="confirm-title">Confirmar</h3>
            <p class="text-sm text-gray-600 mb-6" id="confirm-message">¬øEst√°s seguro?</p>
            <div class="flex justify-end gap-3">
                <button onclick="app.hideConfirm()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button id="btn-confirm-action" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold">S√≠, Cerrar</button>
            </div>
        </div>
    </div>

    <div id="custom-modal-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[160] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <i class="fa-solid fa-info text-blue-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900" id="alert-title">Aviso</h3>
            <p class="text-sm text-gray-500 mt-2 mb-4" id="alert-message">Mensaje...</p>
            <button onclick="document.getElementById('custom-modal-alert').classList.add('hidden')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Entendido</button>
        </div>
    </div>

    <!-- MODAL DE REGLAS (Ayuda Error) -->
    <div id="modal-rules-help" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[170] flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative">
            <button onclick="document.getElementById('modal-rules-help').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
            <h3 class="text-lg font-bold text-red-600 mb-2">‚ö†Ô∏è Error de Permisos Detectado</h3>
            <p class="text-sm text-gray-600 mb-4">Firebase est√° bloqueando la conexi√≥n. Copia estas reglas exactas y p√©galas en tu <b>Firebase Console > Firestore Database > Reglas</b>:</p>
            <div class="bg-gray-100 p-3 rounded text-xs font-mono overflow-auto max-h-60 border border-gray-300 select-all">
<pre>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. Contador Global (Necesario para EXP-0000X)
    match /counters/{document} {
      allow read, write: if request.auth != null;
    }

    // 2. Viajes (Solo el due√±o ve sus viajes)
    match /viajes_simples/{document} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // 3. Gastos (Solo el due√±o ve sus gastos)
    match /gastos_simples/{document} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}</pre>
            </div>
            <button onclick="navigator.clipboard.writeText(document.querySelector('#modal-rules-help pre').innerText); alert('Copiado al portapapeles');" class="w-full mt-4 bg-gray-800 text-white py-2 rounded hover:bg-gray-900">
                Copiar Reglas
            </button>
        </div>
    </div>

    <!-- Navegaci√≥n -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center z-10 no-print">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-lock text-green-600 text-xl"></i>
            <h1 class="font-bold text-lg text-gray-700 tracking-tight">Vi√°ticos <span class="bg-clip-text text-transparent bg-gradient-to-r from-green-500 to-emerald-700 font-extrabold">Safe</span></h1>
        </div>
        <div class="flex gap-3 items-center">
            <span id="user-email-display" class="text-xs text-gray-500 font-bold hidden md:block"></span>
            <button onclick="app.logout()" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded">Salir</button>
            <button onclick="app.showSettings()" class="text-gray-500 hover:text-blue-600 transition ml-2">
                <i class="fa-solid fa-gear text-xl"></i>
            </button>
        </div>
    </nav>

    <main id="main-container" class="flex-1 overflow-y-auto p-4 pb-24 relative">
        
        <!-- VISTA 1: Lista de Viajes -->
        <div id="view-dashboard" class="view-section animate-fade-in pb-20">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Viajes Activos</h2>
                    <p class="text-sm text-gray-500">Tus datos seguros</p>
                </div>
                <button onclick="app.showNewTripModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 active:scale-95 transition flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> Nuevo
                </button>
            </div>

            <!-- Bot√≥n de Ayuda de Reglas si falla -->
            <div id="rules-error-banner" class="hidden mb-4 bg-red-50 border border-red-200 p-4 rounded text-center">
                <p class="text-red-700 font-bold text-sm mb-2"><i class="fa-solid fa-circle-exclamation"></i> Error de Permisos en Base de Datos</p>
                <button onclick="document.getElementById('modal-rules-help').classList.remove('hidden')" class="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                    Ver Soluci√≥n (Reglas Firebase)
                </button>
            </div>

            <div id="trips-list" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 mb-8">
                <div class="text-center p-10 text-gray-400 col-span-full">
                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><br>Cargando tus viajes...
                </div>
            </div>

            <div class="mt-8 border-t border-gray-200 pt-6">
                <h3 class="text-gray-500 font-bold text-sm uppercase mb-3"><i class="fa-solid fa-box-archive mr-1"></i> Buscar Viaje Cerrado</h3>
                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold">EXP-</span>
                        <input type="number" id="search-trip-id" placeholder="000000" class="w-full p-3 pl-14 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none font-mono font-bold text-gray-700">
                    </div>
                    <button onclick="app.searchArchivedTrip()" class="bg-gray-700 text-white px-6 rounded-lg hover:bg-gray-800 font-bold">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA 2: Detalles del Viaje -->
        <div id="view-trip-details" class="view-section hide">
            <div class="flex items-center gap-2 mb-4">
                <button onclick="app.loadDashboard()" class="text-gray-500 hover:text-blue-600">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <div>
                    <h2 id="detail-client-name" class="text-xl font-bold truncate leading-tight">Cliente</h2>
                    <span id="detail-trip-code" class="text-xs font-mono bg-gray-200 text-gray-700 px-1 rounded">EXP-000000</span>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border border-gray-100 relative overflow-hidden">
                <div class="flex justify-between text-sm text-gray-500 mb-2">
                    <span id="detail-trip-date"><i class="fa-regular fa-calendar mr-1"></i> --/--/--</span>
                    <span id="detail-trip-payment" class="bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded text-xs font-bold uppercase">PAYMENT</span>
                </div>
                
                <div class="bg-blue-50 border border-blue-100 p-3 rounded-lg mt-2">
                    <p class="text-xs text-gray-500 uppercase font-bold">Total Estimado (Tarjeta USD)</p>
                    <p class="text-2xl font-bold text-blue-800" id="header-total-usd">$0.00 <span class="text-sm font-normal text-gray-500">USD</span></p>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-3">
                    <button onclick="app.generateReport()" class="bg-indigo-50 text-indigo-600 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-100 transition border border-indigo-100">
                        <i class="fa-solid fa-file-invoice mr-2"></i> Reporte
                    </button>
                    <button id="btn-close-trip" onclick="app.promptArchiveTrip()" class="bg-red-50 text-red-600 py-2 rounded-lg text-sm font-semibold hover:bg-red-100 transition border border-red-100">
                        <i class="fa-solid fa-box-archive mr-2"></i> Cerrar Viaje
                    </button>
                </div>
                
                <div id="archived-banner" class="hidden absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-6 py-1 transform rotate-45 translate-x-4 translate-y-2 shadow-sm">
                    CERRADO
                </div>
            </div>

            <h3 class="font-bold text-gray-700 mb-3">Gastos Registrados</h3>
            <div id="expenses-list" class="space-y-3 pb-20"></div>
            
            <button id="btn-add-floating" onclick="app.showAddExpense()" class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center hover:bg-blue-700 active:scale-90 transition z-20">
                <i class="fa-solid fa-camera text-xl"></i>
            </button>
        </div>

        <!-- VISTA 3: Formulario Nuevo Gasto -->
        <div id="view-add-expense" class="view-section hide">
            <div class="flex items-center gap-2 mb-4">
                <button onclick="app.backToTrip()" class="text-gray-500 hover:text-blue-600">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <h2 class="text-xl font-bold">Registrar Gasto</h2>
            </div>

            <form id="expense-form" onsubmit="app.saveExpense(event)" class="bg-white p-5 rounded-xl shadow-sm space-y-4">
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ticket / Recibo</label>
                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition cursor-pointer" id="drop-area">
                        <input type="file" id="expense-photo" accept="image/*" capture="environment" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="app.handleFileSelect(this)">
                        <div id="preview-container" class="flex flex-col items-center">
                            <i class="fa-solid fa-camera text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-500">Toca para tomar foto</p>
                        </div>
                        <img id="image-preview" class="hidden max-h-48 mx-auto rounded shadow-sm mt-2 object-contain">
                    </div>
                    
                    <button type="button" id="btn-analyze-ticket" onclick="app.analyzeTicketWithGemini()" class="hidden w-full mt-2 ai-sparkle py-2 px-4 rounded-lg shadow-md flex items-center justify-center gap-2 font-bold text-sm transform transition hover:scale-105">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> ‚ú® Autocompletar con IA
                    </button>
                    
                    <p id="upload-status" class="text-xs text-center mt-1 text-blue-500 hidden">Subiendo a Dropbox...</p>
                    <p id="ai-status" class="text-xs text-center mt-1 text-purple-600 font-bold hidden animate-pulse">‚ú® Gemini analizando ticket...</p>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="expense-date" required class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hora</label>
                        <input type="time" id="expense-time" required class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Concepto</label>
                    <select id="expense-concept" required onchange="app.toggleOtherDesc()" class="w-full mt-1 p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="Alimentos">üçî Alimentos</option>
                        <option value="Gasolina">‚õΩ Gasolina</option>
                        <option value="Casetas">üõ£Ô∏è Casetas</option>
                        <option value="Hospedaje">üè® Hospedaje</option>
                        <option value="Transporte">üöï Transporte</option>
                        <option value="Otros">üì¶ Otros</option>
                    </select>
                    <input type="text" id="expense-other-desc" placeholder="Especifique (ej. Propinas)" class="hidden w-full mt-2 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Cantidad Original</label>
                        <input type="number" step="0.01" id="expense-amount" required placeholder="0.00" oninput="app.calculatePreview()" class="w-full mt-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-lg font-bold text-gray-700">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Moneda</label>
                        <select id="expense-currency" onchange="app.toggleExchangeRate()" class="w-full mt-1 p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none font-semibold">
                            <option value="MXN">MXN</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                </div>

                <div id="exchange-rate-container" class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <div class="flex justify-between items-end mb-1">
                        <label class="block text-xs font-bold text-orange-700 uppercase">Tipo de Cambio (MXN a USD)</label>
                        <span id="rate-status" class="text-[10px] text-orange-500"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-sm">1 USD = $</span>
                        <input type="number" step="0.01" id="exchange-rate" value="20.50" oninput="app.calculatePreview()" class="w-24 p-2 border rounded text-right font-bold bg-white">
                        <span class="text-gray-500 text-sm">MXN</span>
                        <button type="button" onclick="app.fetchExchangeRate()" class="text-blue-600 text-xs underline ml-auto" title="Actualizar tasa ahora">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                    </div>
                    <p class="text-xs text-orange-600 mt-1">Ajusta si el banco usa otra tasa.</p>
                </div>

                <div class="mt-4 text-right border-t pt-2">
                    <p class="text-sm text-gray-500">Cargo estimado en tarjeta:</p>
                    <p class="text-xl font-bold text-green-600" id="preview-usd">$0.00 USD</p>
                </div>

                <button type="submit" id="btn-save-expense" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition mt-4 flex justify-center items-center gap-2">
                    <span>Guardar Gasto</span>
                </button>
            </form>
        </div>

        <!-- VISTA 4: Reporte Final -->
        <div id="view-report" class="view-section hide bg-white min-h-full absolute inset-0 z-30 p-6 overflow-y-auto">
            <div class="no-print flex justify-between mb-6">
                <button onclick="app.backToTrip()" class="text-gray-600 flex items-center gap-2 hover:text-blue-600">
                    <i class="fa-solid fa-arrow-left"></i> Regresar
                </button>
                <div class="flex gap-2">
                     <button onclick="app.getTripInsights()" class="ai-sparkle px-3 py-1 rounded shadow text-sm font-bold flex items-center gap-2 hover:opacity-90">
                        <i class="fa-solid fa-brain"></i> Auditor√≠a IA
                    </button>
                    <button onclick="app.printReport()" class="text-blue-600 font-bold flex items-center gap-2 border border-blue-600 px-3 py-1 rounded hover:bg-blue-50">
                        <i class="fa-solid fa-print"></i> PDF / Imprimir
                    </button>
                </div>
            </div>

            <div id="report-section">
                <div class="border-b-2 border-gray-800 pb-4 mb-6 flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Reporte de Gastos</h1>
                        <p class="text-sm text-gray-500 mt-1" id="report-exp-code">EXP-000000</p>
                    </div>
                    <div class="text-right">
                        <div id="report-watermark" class="hidden border-2 border-red-500 text-red-500 font-bold px-2 py-1 rounded transform -rotate-12 text-xs mb-2 inline-block">ARCHIVADO</div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-4 text-gray-600 mb-6">
                    <div>
                        <p class="text-sm uppercase tracking-wide text-gray-500">Cliente</p>
                        <p class="font-bold text-lg text-black" id="report-client">Cliente</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm uppercase tracking-wide text-gray-500 mb-1">Payment</p>
                        <p class="font-bold text-lg text-black uppercase" id="report-payment">USA</p>
                        <p class="text-xs text-gray-400 mt-1" id="report-date">--/--/--</p>
                    </div>
                </div>

                <div id="ai-insights-container" class="hidden mb-6 bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="text-purple-700 font-bold mb-2 flex items-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Resumen de Auditor√≠a IA</h4>
                    <p id="ai-insights-text" class="text-sm text-gray-700 leading-relaxed italic">Generando an√°lisis...</p>
                </div>

                <table class="w-full text-sm text-left text-gray-600 mb-8">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b border-gray-300">
                        <tr>
                            <th class="px-2 py-3">Fecha</th>
                            <th class="px-2 py-3">Concepto</th>
                            <th class="px-2 py-3 text-right">Monto Original</th>
                            <th class="px-2 py-3 text-center">T. Cambio</th>
                            <th class="px-2 py-3 text-right font-bold text-green-700">Total USD (Est.)</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body"></tbody>
                </table>

                <div class="flex flex-col md:flex-row justify-end gap-4">
                    <div class="w-full md:w-1/3 space-y-3">
                        <div class="bg-gray-50 p-4 rounded border border-gray-200">
                            <h4 class="font-bold text-gray-700 border-b border-gray-300 pb-2 mb-2 text-center">Desglose de Origen</h4>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Pesos Reales:</span>
                                <span id="report-real-mxn" class="font-mono">$0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>D√≥lares Reales:</span>
                                <span id="report-real-usd" class="font-mono">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="w-full md:w-1/3 space-y-3">
                        <div class="bg-blue-50 p-4 rounded border border-blue-200 shadow-sm">
                            <h4 class="font-bold text-blue-800 border-b border-blue-300 pb-2 mb-2 text-center">Total Final (USD)</h4>
                            <div class="flex justify-between text-sm mb-1">
                                <span>D√≥lares Reales:</span>
                                <span id="report-final-usd-real">$0.00</span>
                            </div>
                            <div class="flex justify-between text-sm border-b border-blue-200 pb-1 mb-1">
                                <span>D√≥lares Aprox (de MXN):</span>
                                <span id="report-final-usd-approx">$0.00</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold text-gray-700 mt-2 pt-1">
                                <span>Subtotal:</span>
                                <span id="report-subtotal-grand">$0.00 USD</span>
                            </div>
                            
                            <!-- SECCI√ìN CONDICIONAL CUSTOMER -->
                            <div id="customer-surcharge-row" class="hidden border-t border-blue-200 mt-2 pt-2">
                                <div class="flex justify-between text-sm text-indigo-600 font-bold mb-1">
                                    <span>+ Cargo Cliente (15%):</span>
                                    <span id="report-surcharge">$0.00</span>
                                </div>
                                <div class="flex justify-between text-xl font-extrabold text-indigo-800 mt-1">
                                    <span>TOTAL A FACTURAR:</span>
                                    <span id="report-final-bill">$0.00 USD</span>
                                </div>
                            </div>
                            
                            <div id="standard-total-row">
                                <div class="flex justify-between text-xl font-bold text-green-700 mt-2 pt-1">
                                    <span>GRAN TOTAL:</span>
                                    <span id="report-grand-total">$0.00 USD</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-12 pt-8 border-t border-dashed border-gray-300 text-center text-xs text-gray-400">
                    <p>Generado por Gestor de Vi√°ticos</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-new-trip" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up">
            <div class="bg-blue-600 p-4">
                <h3 class="text-white font-bold text-lg">Nuevo Viaje</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                    <input type="text" id="new-trip-client" placeholder="Ej. Empresa ABC" class="w-full mt-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Payment Entity</label>
                    <select id="new-trip-payment" class="w-full mt-1 p-3 border rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="USA">USA</option>
                        <option value="Denmark">Denmark</option>
                        <option value="Customer">Customer</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha de Inicio</label>
                    <input type="date" id="new-trip-date" class="w-full mt-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="app.closeModals()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                    <button onclick="app.createTrip()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Crear Viaje</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="font-bold text-xl mb-4">Configuraci√≥n</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Dropbox Access Token</label>
                <input type="password" id="dropbox-token-input" placeholder="Inserta tu token aqu√≠" class="w-full p-2 border rounded-lg text-sm">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="app.closeModals()" class="px-4 py-2 text-gray-600 rounded-lg">Cerrar</button>
                <button onclick="app.saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, query, where, serverTimestamp, updateDoc, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        if (window.location.protocol === 'file:') document.getElementById('protocol-warning').classList.remove('hidden');

        const apiKey = ""; 

        const firebaseConfig = {
            apiKey: "AIzaSyClZTvz0_GvqNlw7BIogRPYjQtPKQd9SL4",
            authDomain: "fw-expenses.firebaseapp.com",
            databaseURL: "https://fw-expenses-default-rtdb.firebaseio.com",
            projectId: "fw-expenses",
            storageBucket: "fw-expenses.firebasestorage.app",
            messagingSenderId: "1083599671052",
            appId: "1:1083599671052:web:e69165ad332c7c46000329"
        };

        let appFirebase, auth, db;
        try {
            appFirebase = initializeApp(firebaseConfig);
            auth = getAuth(appFirebase);
            db = getFirestore(appFirebase);
            setPersistence(auth, browserLocalPersistence);
        } catch (e) { alert("Error iniciando Firebase: " + e.message); }

        const state = {
            currentTrip: null,
            expenses: [],
            dropboxToken: localStorage.getItem('dropbox_token') || '',
            currentFile: null,
            base64Image: null,
            user: null
        };

        window.app = {
            // ... UI FUNCTIONS ...
            showView: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide'));
                document.getElementById(viewId).classList.remove('hide');
                window.scrollTo(0,0);
            },
            showSettings: () => {
                document.getElementById('dropbox-token-input').value = state.dropboxToken;
                document.getElementById('modal-settings').classList.remove('hidden');
            },
            saveSettings: () => {
                state.dropboxToken = document.getElementById('dropbox-token-input').value.trim();
                localStorage.setItem('dropbox_token', state.dropboxToken);
                app.closeModals();
            },
            closeModals: () => {
                document.getElementById('modal-new-trip').classList.add('hidden');
                document.getElementById('modal-settings').classList.add('hidden');
            },
            showNewTripModal: () => {
                document.getElementById('new-trip-date').valueAsDate = new Date();
                document.getElementById('modal-new-trip').classList.remove('hidden');
            },
            loadDashboard: () => {
                state.currentTrip = null;
                app.showView('view-dashboard');
            },
            showLoader: (msg) => {
                document.getElementById('loader-text').innerText = msg;
                document.getElementById('full-screen-loader').classList.remove('hidden');
            },
            hideLoader: () => {
                document.getElementById('full-screen-loader').classList.add('hidden');
            },
            showAlert: (title, msg) => {
                document.getElementById('alert-title').innerText = title;
                document.getElementById('alert-message').innerText = msg;
                document.getElementById('custom-modal-alert').classList.remove('hidden');
            },
            hideConfirm: () => {
                document.getElementById('custom-modal-confirm').classList.add('hidden');
            },

            // --- LOGIN SYSTEM ---
            handleLogin: async (e) => {
                e.preventDefault();
                const rawUser = document.getElementById('login-username').value;
                const username = rawUser.replace(/\s+/g, ''); // Eliminar espacios
                const pass = document.getElementById('login-pass').value;
                
                if (pass.length < 6) return app.showAlert("Contrase√±a corta", "M√≠nimo 6 caracteres.");
                const email = `${username}@viaticos.app`; 

                app.showLoader("Iniciando sesi√≥n segura...");
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        try {
                            app.showLoader("Creando cuenta nueva...");
                            await createUserWithEmailAndPassword(auth, email, pass);
                        } catch (createErr) {
                            if (createErr.code === 'auth/operation-not-allowed') {
                                app.showAlert("Error Configuraci√≥n", "Falta activar 'Email/Password' en la consola de Firebase.");
                            } else {
                                app.showAlert("Error Registro", createErr.message);
                            }
                        }
                    } else if (error.code === 'auth/operation-not-allowed') {
                         app.showAlert("Error Configuraci√≥n", "Falta activar 'Email/Password' en la consola de Firebase.");
                    } else {
                        app.showAlert("Error Login", error.message);
                    }
                } finally {
                    app.hideLoader();
                }
            },
            logout: () => {
                signOut(auth);
                location.reload();
            },

            // --- VIAJES ---
            createTrip: async () => {
                if(!state.user) return app.showAlert("Error", "No autenticado");
                const client = document.getElementById('new-trip-client').value.trim();
                const date = document.getElementById('new-trip-date').value;
                const payment = document.getElementById('new-trip-payment').value;

                if(!client || !date) return app.showAlert("Faltan Datos", "Completa el nombre y la fecha.");
                app.showLoader("Creando viaje secuencial...");

                try {
                    const tripRef = doc(collection(db, 'viajes_simples'));
                    const counterRef = doc(db, 'counters', 'global_trips');

                    await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        let newCount = 1;
                        if (counterDoc.exists()) {
                            const current = counterDoc.data().current || 0;
                            newCount = current + 1;
                        }
                        const expCode = 'EXP-' + String(newCount).padStart(6, '0');
                        transaction.set(counterRef, { current: newCount }, { merge: true });
                        
                        const tripData = {
                            client: client,
                            payment: payment,
                            startDate: date,
                            status: 'active',
                            expCode: expCode,
                            createdAt: serverTimestamp(),
                            userId: state.user.uid
                        };
                        transaction.set(tripRef, tripData);
                        state.tempNewTrip = { id: tripRef.id, ...tripData, createdAt: new Date() };
                    });
                    
                    app.closeModals();
                    document.getElementById('new-trip-client').value = '';
                    app.selectTrip(state.tempNewTrip);

                } catch (e) {
                    console.error(e);
                    app.showAlert("Error", "No se pudo guardar. Verifica reglas de Firebase.");
                } finally {
                    app.hideLoader();
                }
            },
            
            promptArchiveTrip: () => {
                if(!state.currentTrip) return;
                const modal = document.getElementById('custom-modal-confirm');
                document.getElementById('confirm-title').innerText = "Cerrar Viaje";
                document.getElementById('confirm-message').innerText = `¬øSeguro que deseas cerrar ${state.currentTrip.expCode}? Se archivar√°.`;
                document.getElementById('btn-confirm-action').onclick = () => {
                    app.hideConfirm();
                    app.doArchiveTrip();
                };
                modal.classList.remove('hidden');
            },

            doArchiveTrip: async () => {
                app.showLoader("Archivando...");
                try {
                    const tripRef = doc(db, 'viajes_simples', state.currentTrip.id);
                    await updateDoc(tripRef, { status: 'archived' });
                    app.showAlert("√âxito", "Viaje cerrado y archivado.");
                    app.loadDashboard();
                } catch(e) {
                    console.error(e);
                    app.showAlert("Error", "No se pudo archivar.");
                } finally {
                    app.hideLoader();
                }
            },

            searchArchivedTrip: async () => {
                const inputVal = document.getElementById('search-trip-id').value.trim();
                if(!inputVal) return app.showAlert("B√∫squeda", "Ingresa el n√∫mero del viaje");
                
                const paddedNum = String(inputVal).padStart(6, '0');
                const searchCode = 'EXP-' + paddedNum;
                
                app.showLoader(`Buscando ${searchCode}...`);

                try {
                    const q = query(
                        collection(db, 'viajes_simples'), 
                        where('expCode', '==', searchCode),
                        where('userId', '==', state.user.uid)
                    );
                    const querySnapshot = await getDocs(q);
                    
                    if(querySnapshot.empty) {
                        app.showAlert("No encontrado", "No existe ning√∫n viaje tuyo con ese n√∫mero.");
                    } else {
                        const docSnap = querySnapshot.docs[0];
                        const tripData = { id: docSnap.id, ...docSnap.data() };
                        app.selectTrip(tripData);
                    }
                } catch(e) {
                    console.error(e);
                    app.showAlert("Error", "Fall√≥ la b√∫squeda.");
                } finally {
                    app.hideLoader();
                }
            },

            selectTrip: (trip) => {
                state.currentTrip = trip;
                document.getElementById('detail-client-name').innerText = trip.client;
                document.getElementById('detail-trip-date').innerHTML = `<i class="fa-regular fa-calendar mr-1"></i> ${trip.startDate}`;
                document.getElementById('detail-trip-code').innerText = trip.expCode || 'SIN-CODIGO';
                
                const paymentTag = document.getElementById('detail-trip-payment');
                paymentTag.innerText = trip.payment || "USA";
                
                if(trip.payment === 'Denmark') paymentTag.className = "bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs font-bold uppercase";
                else if(trip.payment === 'Customer') paymentTag.className = "bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold uppercase";
                else paymentTag.className = "bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs font-bold uppercase";

                const btnClose = document.getElementById('btn-close-trip');
                const btnAdd = document.getElementById('btn-add-floating');
                const banner = document.getElementById('archived-banner');

                if (trip.status === 'archived') {
                    btnClose.classList.add('hidden');
                    btnAdd.classList.add('hidden');
                    banner.classList.remove('hidden');
                } else {
                    btnClose.classList.remove('hidden');
                    btnAdd.classList.remove('hidden');
                    banner.classList.add('hidden');
                }

                app.listenToExpenses(trip.id);
                app.showView('view-trip-details');
            },
            
            toggleOtherDesc: () => {
                const concept = document.getElementById('expense-concept').value;
                const otherInput = document.getElementById('expense-other-desc');
                if(concept === 'Otros') {
                    otherInput.classList.remove('hidden');
                    otherInput.required = true;
                } else {
                    otherInput.classList.add('hidden');
                    otherInput.required = false;
                    otherInput.value = '';
                }
            },

            showAddExpense: () => {
                document.getElementById('expense-form').reset();
                document.getElementById('expense-date').valueAsDate = new Date();
                document.getElementById('expense-time').value = new Date().toTimeString().slice(0,5);
                app.fetchExchangeRate();
                app.toggleExchangeRate();
                app.toggleOtherDesc();
                state.currentFile = null;
                state.base64Image = null;
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('preview-container').classList.remove('hidden');
                document.getElementById('upload-status').classList.add('hidden');
                document.getElementById('ai-status').classList.add('hidden');
                document.getElementById('btn-analyze-ticket').classList.add('hidden');
                document.getElementById('preview-usd').innerText = "$0.00 USD";
                app.showView('view-add-expense');
            },
            fetchExchangeRate: async () => {
                const rateStatus = document.getElementById('rate-status');
                rateStatus.innerText = "Actualizando...";
                try {
                    const response = await fetch("https://open.er-api.com/v6/latest/USD");
                    const data = await response.json();
                    if(data && data.rates && data.rates.MXN) {
                        const rate = data.rates.MXN;
                        document.getElementById('exchange-rate').value = rate.toFixed(2);
                        rateStatus.innerText = `Actualizado: $${rate.toFixed(2)}`;
                        app.calculatePreview();
                    }
                } catch (e) { rateStatus.innerText = "Usando valor guardado"; }
            },
            toggleExchangeRate: () => {
                const currency = document.getElementById('expense-currency').value;
                if(currency === 'MXN') document.getElementById('exchange-rate-container').classList.remove('hidden');
                else document.getElementById('exchange-rate-container').classList.add('hidden');
                app.calculatePreview();
            },
            calculatePreview: () => {
                const amount = parseFloat(document.getElementById('expense-amount').value) || 0;
                const currency = document.getElementById('expense-currency').value;
                const rate = parseFloat(document.getElementById('exchange-rate').value) || 1;
                let finalUSD = (currency === 'MXN') ? amount / rate : amount;
                document.getElementById('preview-usd').innerText = `$${finalUSD.toFixed(2)} USD`;
            },
            backToTrip: () => { app.showView('view-trip-details'); },
            handleFileSelect: (input) => {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    state.currentFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('image-preview').src = e.target.result;
                        document.getElementById('image-preview').classList.remove('hidden');
                        document.getElementById('preview-container').classList.add('hidden');
                        state.base64Image = e.target.result.split(',')[1];
                        document.getElementById('btn-analyze-ticket').classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            },
            analyzeTicketWithGemini: async () => {
                if (!state.base64Image) return app.showAlert("Error", "Selecciona una foto.");
                const btn = document.getElementById('btn-analyze-ticket');
                btn.disabled = true; btn.innerHTML = "Analizando...";
                try {
                    if(!apiKey) throw new Error("API Key no disponible.");
                    const prompt = `Analiza imagen ticket... responde JSON: {"date":"YYYY-MM-DD","time":"HH:MM","amount":0.00,"currency":"MXN","concept":"Alimentos"}`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: state.base64Image } }] }] })
                    });
                    const data = await response.json();
                    const cleanJson = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const result = JSON.parse(cleanJson);
                    if (result.date) document.getElementById('expense-date').value = result.date;
                    if (result.time) document.getElementById('expense-time').value = result.time;
                    if (result.amount) document.getElementById('expense-amount').value = result.amount;
                    if (result.currency) {
                        document.getElementById('expense-currency').value = result.currency;
                        app.toggleExchangeRate();
                    }
                    if (result.concept) document.getElementById('expense-concept').value = result.concept;
                    app.calculatePreview();
                } catch (error) { app.showAlert("Error IA", error.message); } finally { btn.disabled = false; btn.innerHTML = "‚ú® IA"; }
            },
            getTripInsights: async () => {
                if(!apiKey) return;
                document.getElementById('ai-insights-container').classList.remove('hidden');
                document.getElementById('ai-insights-text').innerText = "Auditando...";
                try {
                    const expensesSummary = state.expenses.map(e => `${e.concept}: $${e.finalUSD.toFixed(2)}`).join('\n');
                    const prompt = `Analiza gastos breves: ${expensesSummary}`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    document.getElementById('ai-insights-text').innerText = data.candidates[0].content.parts[0].text;
                } catch (e) { document.getElementById('ai-insights-text').innerText = "Error IA."; }
            },
            uploadToDropbox: async (file) => {
                if (!state.dropboxToken) return null;
                try {
                    document.getElementById('upload-status').classList.remove('hidden');
                    const dbx = new Dropbox.Dropbox({ accessToken: state.dropboxToken });
                    const tripCode = state.currentTrip.expCode || 'SIN-CODIGO';
                    const consecutive = state.expenses.length + 1;
                    const extension = file.name.split('.').pop();
                    const finalName = `${tripCode}-${consecutive}.${extension}`;
                    const fileName = `/gastos_app/${finalName}`;
                    const response = await dbx.filesUpload({ path: fileName, contents: file });
                    const share = await dbx.sharingCreateSharedLinkWithSettings({ path: response.result.path_lower });
                    return share.result.url;
                } catch (error) { return null; }
            },
            saveExpense: async (e) => {
                e.preventDefault();
                app.showLoader("Guardando...");
                let photoUrl = "";
                if (state.currentFile && state.dropboxToken) {
                    const url = await app.uploadToDropbox(state.currentFile);
                    if (url) photoUrl = url;
                } else if (state.currentFile) { photoUrl = "https://placehold.co/600x400/orange/white?text=Foto+Local"; }

                const amount = parseFloat(document.getElementById('expense-amount').value);
                const currency = document.getElementById('expense-currency').value;
                let rate = 1;
                let finalUSD = amount;
                if(currency === 'MXN') {
                    rate = parseFloat(document.getElementById('exchange-rate').value);
                    finalUSD = amount / rate;
                }
                
                // L√≥gica Otros
                let concept = document.getElementById('expense-concept').value;
                if (concept === 'Otros') {
                    const desc = document.getElementById('expense-other-desc').value.trim();
                    if (desc) concept = `Otros: ${desc}`;
                }

                const expenseData = {
                    tripId: state.currentTrip.id,
                    userId: state.user.uid,
                    date: document.getElementById('expense-date').value,
                    time: document.getElementById('expense-time').value,
                    concept: concept,
                    amount: amount,
                    currency: currency,
                    exchangeRate: rate,
                    finalUSD: finalUSD,
                    photoUrl: photoUrl,
                    createdAt: serverTimestamp()
                };
                try {
                    await addDoc(collection(db, 'gastos_simples'), expenseData);
                    app.backToTrip();
                } catch (err) { app.showAlert("Error", "Fallo al guardar gasto. " + err.message); } finally { app.hideLoader(); }
            },
            listenToExpenses: (tripId) => {
                const q = query(
                    collection(db, 'gastos_simples'), 
                    where("tripId", "==", tripId),
                    where("userId", "==", state.user.uid)
                );
                onSnapshot(q, (snapshot) => {
                    state.expenses = [];
                    snapshot.forEach(doc => state.expenses.push({ id: doc.id, ...doc.data() }));
                    state.expenses.sort((a,b) => new Date(b.date) - new Date(a.date));
                    app.renderExpenses();
                });
            },
            renderExpenses: () => {
                const container = document.getElementById('expenses-list');
                container.innerHTML = '';
                let totalUSD = 0;
                state.expenses.forEach(exp => {
                    totalUSD += exp.finalUSD;
                    let icon = 'fa-receipt';
                    if(exp.concept === 'Alimentos') icon = 'fa-burger'; else if(exp.concept === 'Gasolina') icon = 'fa-gas-pump';
                    const el = document.createElement('div');
                    el.className = 'bg-white p-3 rounded-lg shadow-sm flex justify-between items-center border-l-4 border-blue-500';
                    el.innerHTML = `<div class="flex items-center gap-3"><div class="bg-blue-50 p-2 rounded-full text-blue-600 w-10 h-10 flex items-center justify-center"><i class="fa-solid ${icon}"></i></div><div><p class="font-bold text-gray-800">${exp.concept}</p><p class="text-xs text-gray-500">${exp.date}</p></div></div><div class="text-right"><p class="font-bold text-gray-900">$${exp.finalUSD.toFixed(2)} USD</p><p class="text-xs text-gray-400">(${exp.amount} ${exp.currency})</p>${exp.photoUrl ? `<a href="${exp.photoUrl}" target="_blank" class="text-xs text-blue-500 underline"><i class="fa-solid fa-paperclip"></i></a>` : ''}</div>`;
                    container.appendChild(el);
                });
                document.getElementById('header-total-usd').innerHTML = `$${totalUSD.toFixed(2)} <span class="text-sm font-normal text-gray-500">USD</span>`;
            },
            generateReport: () => {
                app.showView('view-report');
                document.getElementById('ai-insights-container').classList.add('hidden');
                document.getElementById('report-client').innerText = state.currentTrip.client;
                document.getElementById('report-date').innerText = state.currentTrip.startDate;
                document.getElementById('report-exp-code').innerText = state.currentTrip.expCode || 'EXP-000000';
                document.title = state.currentTrip.expCode || "Reporte_Gastos";

                const paymentType = state.currentTrip.payment || "USA";
                document.getElementById('report-payment').innerText = paymentType;
                
                if(state.currentTrip.status === 'archived') document.getElementById('report-watermark').classList.remove('hidden');
                else document.getElementById('report-watermark').classList.add('hidden');

                const tbody = document.getElementById('report-table-body');
                tbody.innerHTML = '';
                const reportExpenses = [...state.expenses].reverse();
                let realPesos = 0, realUSD = 0, approxUSDfromPesos = 0;
                reportExpenses.forEach(exp => {
                    if(exp.currency === 'MXN') { realPesos += exp.amount; approxUSDfromPesos += exp.finalUSD; } 
                    else { realUSD += exp.amount; }
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    tr.innerHTML = `<td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${exp.date}</td><td class="px-2 py-2">${exp.concept}</td><td class="px-2 py-2 text-right text-gray-600">$${exp.amount} <span class="text-[10px] font-bold">${exp.currency}</span></td><td class="px-2 py-2 text-center text-xs">${exp.currency === 'MXN' ? exp.exchangeRate.toFixed(2) : '-'}</td><td class="px-2 py-2 text-right font-mono font-bold text-green-700">$${exp.finalUSD.toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
                document.getElementById('report-real-mxn').innerText = `$${realPesos.toFixed(2)} MXN`;
                document.getElementById('report-real-usd').innerText = `$${realUSD.toFixed(2)} USD`;
                document.getElementById('report-final-usd-real').innerText = `$${realUSD.toFixed(2)}`;
                document.getElementById('report-final-usd-approx').innerText = `$${approxUSDfromPesos.toFixed(2)}`;
                const grandTotal = realUSD + approxUSDfromPesos;
                
                document.getElementById('report-subtotal-grand').innerText = `$${grandTotal.toFixed(2)} USD`;
                if (paymentType === 'Customer') {
                    const surcharge = grandTotal * 0.15;
                    const finalBill = grandTotal + surcharge;
                    document.getElementById('report-surcharge').innerText = `$${surcharge.toFixed(2)}`;
                    document.getElementById('report-final-bill').innerText = `$${finalBill.toFixed(2)} USD`;
                    document.getElementById('customer-surcharge-row').classList.remove('hidden');
                    document.getElementById('standard-total-row').classList.add('hidden');
                } else {
                    document.getElementById('customer-surcharge-row').classList.add('hidden');
                    document.getElementById('standard-total-row').classList.remove('hidden');
                    document.getElementById('report-grand-total').innerText = `$${grandTotal.toFixed(2)} USD`;
                }
            },
            printReport: () => {
                window.print();
                setTimeout(() => document.title = "Gestor de Vi√°ticos", 1000);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                state.user = user;
                document.getElementById('login-screen').classList.add('hidden');
                const username = user.email.split('@')[0].toUpperCase();
                document.getElementById('connection-status').innerText = "Conectado: " + username;
                document.getElementById('user-email-display').innerText = username;
                
                const q = query(
                    collection(db, 'viajes_simples'), 
                    where('status', '==', 'active'),
                    where('userId', '==', user.uid)
                );
                onSnapshot(q, (snapshot) => {
                    const container = document.getElementById('trips-list');
                    container.innerHTML = '';
                    const trips = [];
                    snapshot.forEach(doc => trips.push({id: doc.id, ...doc.data()}));
                    trips.sort((a, b) => {
                        const timeA = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : Date.now()/1000;
                        const timeB = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : Date.now()/1000;
                        return timeB - timeA;
                    });
                    if(trips.length === 0) {
                        container.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-10">No hay viajes activos.<br>Crea uno nuevo o busca uno archivado.</div>`;
                        return;
                    }
                    trips.forEach((data) => {
                        const payment = data.payment || 'USA';
                        let badgeClass = "bg-blue-100 text-blue-800";
                        if(payment === 'Denmark') badgeClass = "bg-red-100 text-red-800";
                        if(payment === 'Customer') badgeClass = "bg-green-100 text-green-800";

                        const card = document.createElement('div');
                        card.className = 'bg-white p-5 rounded-xl shadow hover:shadow-md transition cursor-pointer border border-transparent hover:border-orange-300 relative';
                        card.onclick = () => app.selectTrip(data);
                        card.innerHTML = `
                            <span class="absolute top-2 right-2 text-[10px] font-mono bg-gray-100 px-1 rounded text-gray-500">${data.expCode || ''}</span>
                            <div class="flex justify-between items-start mb-2 mt-2">
                                <h3 class="font-bold text-lg text-gray-800 truncate">${data.client}</h3>
                            </div>
                            <p class="text-sm text-gray-500"><i class="fa-regular fa-calendar mr-1"></i> ${data.startDate}</p>
                            <div class="mt-3 flex items-center gap-2">
                                <span class="${badgeClass} text-xs px-2 py-1 rounded-full font-bold uppercase">${payment}</span>
                            </div>`;
                        container.appendChild(card);
                    });
                }, (error) => {
                    console.error(error);
                    if(error.code === 'permission-denied')
                        document.getElementById('trips-list').innerHTML = `<div class="col-span-full bg-red-50 text-red-600 p-4 rounded text-center">Permiso denegado por seguridad. Verifica tus reglas.</div>`;
                });
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
